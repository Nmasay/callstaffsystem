<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>呼び出しモニター - 従業員用</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap');
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        .transition-theme { transition: background-color 0.4s ease, border-color 0.4s ease, color 0.4s ease, box-shadow 0.4s ease; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen flex flex-col items-center justify-center p-4 md:p-8">

    <div class="w-full max-w-5xl">
        <div id="mainDisplayCard" class="bg-white rounded-[3rem] shadow-2xl overflow-hidden border border-slate-100 min-h-[70vh] flex flex-col transition-theme">
            <div id="callingHeader" class="relative py-4 px-6 text-center text-white transition-theme duration-500 flex items-center justify-center min-h-[80px]">
                <span id="groupIndicator" class="absolute left-6 bg-white/20 px-4 py-2 rounded-xl text-sm font-black uppercase tracking-wider">---</span>
                <i id="mainBell" data-lucide="bell" class="w-12 h-12 text-white"></i>
            </div>

            <div class="flex-1 flex flex-col items-center justify-center p-8 text-center relative">
                <div id="nameDisplay" class="text-7xl md:text-9xl font-black tracking-tight leading-tight break-words px-4 text-slate-800">
                    接続中...
                </div>
                <div id="calledBadge" class="hidden mt-8 px-8 py-3 rounded-full font-bold text-2xl shadow-md animate-pulse text-white">
                    呼出済み
                </div>
                <div id="skipBadge" class="hidden mt-8 bg-red-100 text-red-600 px-8 py-3 rounded-full font-bold text-2xl shadow-md">
                    一時スキップ中
                </div>
            </div>
            
            <!-- 音声再生許可のためのボタン（初回クリック用） -->
            <button id="enableSoundBtn" class="absolute bottom-4 right-4 bg-white/50 p-3 rounded-full text-slate-400 hover:text-slate-600 hover:bg-white transition-all z-50" onclick="this.remove()" title="音声再生を有効にする">
                <i data-lucide="volume-2" class="w-6 h-6"></i>
            </button>
        </div>
        
        <div class="mt-4 text-center text-slate-400 text-xs font-mono">
            <span id="syncStatus">Initializing...</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVQSIE31_9L3oadT0koVikEVEh3EeQJBw",
            authDomain: "callstaffsystem.firebaseapp.com",
            projectId: "callstaffsystem",
            storageBucket: "callstaffsystem.firebasestorage.app",
            messagingSenderId: "52018004009",
            appId: "1:52018004009:web:be90853cb230c3211f5c38"
        };
        
        const appId = 'employee-call-sync-v7';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const statusDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'syncStatus', 'global');

        const groupThemes = {
            A: { label: '早番A', bg: 'bg-slate-700' },
            B: { label: '早番B', bg: 'bg-indigo-700' },
            C: { label: '遅番C', bg: 'bg-emerald-700' },
            D: { label: '遅番D', bg: 'bg-rose-700' }
        };

        let callingAppState = {
            activeGroup: 'A',
            groups: {},
            triggerChime: false
        };

        // 認証
        signInAnonymously(auth).catch(console.error);
        onAuthStateChanged(auth, (user) => {
            if (user) {
                listenToDatabase();
            }
        });

        function listenToDatabase() {
            onSnapshot(statusDocRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    const chimeWasOff = !callingAppState.triggerChime;
                    callingAppState = data;
                    
                    renderUI();
                    
                    if (callingAppState.triggerChime && chimeWasOff) {
                        playChimeSound();
                    }
                    document.getElementById('syncStatus').textContent = "● LIVE SYNC";
                }
            });
        }

        function renderUI() {
            const activeKey = callingAppState.activeGroup;
            const theme = groupThemes[activeKey];
            const groupData = callingAppState.groups[activeKey] || { currentIndex: 0, members: [] };
            const currentMember = (groupData.members && groupData.members[groupData.currentIndex]) || { name: "待機中", disabled: false };

            document.getElementById('groupIndicator').textContent = theme.label;
            
            const nameEl = document.getElementById('nameDisplay');
            nameEl.innerHTML = `
                ${currentMember.name}<span class="text-4xl md:text-6xl text-slate-300 ml-6 font-normal align-baseline">x${currentMember.count || 0}</span>
            `;
            nameEl.className = `text-7xl md:text-9xl font-black tracking-tight leading-tight break-words px-4 ${currentMember.disabled ? 'text-slate-200' : 'text-slate-800'}`;
            
            document.getElementById('callingHeader').className = `relative py-4 px-6 text-center text-white transition-theme duration-500 flex items-center justify-center min-h-[80px] ${currentMember.disabled ? 'bg-slate-400' : theme.bg}`;
            document.getElementById('mainBell').className = `w-12 h-12 text-white ${!currentMember.disabled ? 'animate-bounce' : 'opacity-30'}`;
            document.getElementById('skipBadge').classList.toggle('hidden', !currentMember.disabled);
            
            const calledBadge = document.getElementById('calledBadge');
            if (!currentMember.disabled && groupData.members && groupData.members.length > 0) {
                calledBadge.className = `mt-8 px-8 py-3 rounded-full font-bold text-2xl shadow-md animate-pulse text-white ${theme.bg}`;
                calledBadge.classList.remove('hidden');
            } else {
                calledBadge.classList.add('hidden');
            }
            
            lucide.createIcons();
        }

        function playChimeSound() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const now = ctx.currentTime;
                const note = (freq, offset, duration) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, now + offset);
                    gain.gain.setValueAtTime(0, now + offset);
                    gain.gain.linearRampToValueAtTime(0.2, now + offset + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + offset + duration);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start(now + offset);
                    osc.stop(now + offset + duration);
                };
                note(660, 0, 0.6);
                note(523, 0.5, 0.8);
            } catch (e) { console.error(e); }
        }
    </script>
</body>
</html>